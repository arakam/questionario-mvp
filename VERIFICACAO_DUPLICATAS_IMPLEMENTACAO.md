# üîç Implementa√ß√£o de Verifica√ß√£o de Duplicatas por E-mail ou Telefone

## üéØ **Objetivo**

Permitir que cada question√°rio escolha entre **e-mail** ou **telefone** como campo de verifica√ß√£o para identificar respostas duplicadas, oferecendo flexibilidade para diferentes tipos de question√°rios.

## ‚ú® **Funcionalidades Implementadas**

### **1. Escolha do Campo de Verifica√ß√£o**
- ‚úÖ **E-mail** - Verifica√ß√£o tradicional por endere√ßo de e-mail
- ‚úÖ **Telefone** - Verifica√ß√£o alternativa por n√∫mero de telefone
- ‚úÖ **Configura√ß√£o por question√°rio** - Cada question√°rio pode ter sua pr√≥pria configura√ß√£o
- ‚úÖ **Valida√ß√£o autom√°tica** - Apenas um campo pode ser marcado como verifica√ß√£o

### **2. Interface de Configura√ß√£o**
- ‚úÖ **Checkbox de verifica√ß√£o** - Marcar campos como campo de verifica√ß√£o
- ‚úÖ **Valida√ß√£o visual** - Apenas campos email/telefone podem ser verificados
- ‚úÖ **Feedback claro** - Indica√ß√£o visual de qual campo est√° sendo usado
- ‚úÖ **Configura√ß√£o intuitiva** - Interface simples e direta

### **3. L√≥gica de Verifica√ß√£o Inteligente**
- ‚úÖ **Detec√ß√£o autom√°tica** - Sistema identifica qual campo usar
- ‚úÖ **Fallback para e-mail** - Se n√£o configurado, usa e-mail por padr√£o
- ‚úÖ **Valida√ß√£o de obrigatoriedade** - Telefone obrigat√≥rio quando √© campo de verifica√ß√£o
- ‚úÖ **Logs detalhados** - Rastreamento de qual campo foi usado

## üóÑÔ∏è **Banco de Dados**

### **Script SQL** (`UPDATE_VERIFICACAO_DUPLICATAS.sql`)
Execute no Supabase para implementar a funcionalidade:

```sql
-- Execute o script completo:
-- UPDATE_VERIFICACAO_DUPLICATAS.sql
```

### **Novas Estruturas:**

#### **Tabela `questionarios`:**
- **`campos_configuraveis`** - JSONB com configura√ß√£o dos campos
- **Campo `campoVerificacao`** - Boolean indicando se o campo √© usado para verifica√ß√£o

#### **Tabela `pessoas`:**
- **`telefone`** - Campo para armazenar n√∫mero de telefone
- **Constraints √∫nicas** - (email + questionario_id) e (telefone + questionario_id)

### **Exemplo de Configura√ß√£o:**
```json
[
  {
    "id": "email",
    "label": "E-mail",
    "tipo": "email",
    "obrigatorio": true,
    "campoVerificacao": true
  },
  {
    "id": "telefone",
    "label": "Telefone",
    "tipo": "telefone",
    "obrigatorio": false,
    "campoVerificacao": false
  }
]
```

## üõ†Ô∏è **Componentes Criados/Modificados**

### **1. ConfiguracaoCampos.tsx** (Modificado)
- ‚úÖ **Checkbox de verifica√ß√£o** para campos email/telefone
- ‚úÖ **Valida√ß√£o visual** de campos de verifica√ß√£o
- ‚úÖ **Interface intuitiva** para configura√ß√£o

### **2. API de Pessoas** (Modificado)
- ‚úÖ **Detec√ß√£o autom√°tica** do campo de verifica√ß√£o
- ‚úÖ **Valida√ß√£o de obrigatoriedade** do telefone
- ‚úÖ **Logs detalhados** de qual campo foi usado
- ‚úÖ **Fallback para e-mail** quando n√£o configurado

### **3. P√°ginas de Question√°rios** (Modificadas)
- ‚úÖ **Campos padr√£o** com configura√ß√£o de verifica√ß√£o
- ‚úÖ **Interface atualizada** para incluir campoVerificacao
- ‚úÖ **Valida√ß√µes autom√°ticas** implementadas

## üöÄ **Como Implementar**

### **1. Prepara√ß√£o do Banco de Dados**

#### **‚ö†Ô∏è IMPORTANTE: Se voc√™ receber erro de constraint √∫nica**

Se voc√™ receber o erro:
```
ERROR: 23505: could not create unique index "pessoas_telefone_questionario_id_key"
DETAIL: Key (telefone, questionario_id)=(...) is duplicated.
```

**Execute primeiro os scripts de corre√ß√£o:**
```sql
-- 1. Corrigir duplicatas (se houver):
CORRECAO_DUPLICATAS_TELEFONE_SUPER_SIMPLES.sql

-- 2. Permitir email NULL:
CORRECAO_COLUNA_EMAIL_NULL.sql
```

#### **Script Principal:**
```bash
# No painel do Supabase, execute:
UPDATE_VERIFICACAO_DUPLICATAS.sql
```

### **2. Atualizar o C√≥digo**
```bash
# Os componentes j√° foram atualizados automaticamente
# Verifique se as mudan√ßas foram aplicadas corretamente
```

### **3. Testar a Funcionalidade**
```bash
npm run dev
# Acesse /admin/questionarios/novo
# Configure campos com verifica√ß√£o por telefone
# Teste a resposta do question√°rio
```

## üì± **Como Usar**

### **1. Configurar Verifica√ß√£o por E-mail (Padr√£o)**
1. Acesse `/admin/questionarios/novo`
2. Os campos padr√£o j√° t√™m e-mail marcado como verifica√ß√£o
3. Crie o question√°rio normalmente
4. Sistema verifica duplicatas por e-mail

### **2. Configurar Verifica√ß√£o por Telefone**
1. Acesse `/admin/questionarios/novo`
2. Na se√ß√£o de campos configur√°veis:
   - Desmarque o checkbox de verifica√ß√£o do e-mail
   - Marque o checkbox de verifica√ß√£o do telefone
   - O telefone se torna obrigat√≥rio automaticamente
3. Crie o question√°rio
4. Sistema verifica duplicatas por telefone

### **3. Configurar Question√°rio Existente**
1. Acesse `/admin/questionarios/[id]/campos`
2. Modifique a configura√ß√£o dos campos
3. Marque/desmarque campos de verifica√ß√£o conforme necess√°rio
4. Salve as altera√ß√µes

## üîß **Configura√ß√µes Dispon√≠veis**

### **Campo de Verifica√ß√£o:**
- **E-mail** - Verifica√ß√£o tradicional, sempre obrigat√≥rio
- **Telefone** - Verifica√ß√£o alternativa, obrigat√≥rio quando configurado

### **Valida√ß√µes Autom√°ticas:**
- ‚úÖ **Apenas um campo** pode ser marcado como verifica√ß√£o
- ‚úÖ **Apenas email/telefone** podem ser campos de verifica√ß√£o
- ‚úÖ **Telefone obrigat√≥rio** quando √© campo de verifica√ß√£o
- ‚úÖ **Constraints √∫nicas** para ambos os campos

### **Comportamento do Sistema:**
- üîç **Detec√ß√£o autom√°tica** do campo de verifica√ß√£o
- üìù **Logs detalhados** de qual campo foi usado
- ‚ö†Ô∏è **Valida√ß√µes** antes de processar respostas
- üîÑ **Fallback** para e-mail quando n√£o configurado

## üìä **Exemplos de Uso**

### **Question√°rio de Satisfa√ß√£o (Verifica√ß√£o por E-mail):**
```json
{
  "id": "email",
  "tipo": "email",
  "campoVerificacao": true
}
```
- Usu√°rios respondem com e-mail
- Sistema verifica duplicatas por e-mail
- E-mail sempre obrigat√≥rio

### **Question√°rio Empresarial (Verifica√ß√£o por Telefone):**
```json
{
  "id": "telefone",
  "tipo": "telefone",
  "campoVerificacao": true
}
```
- Usu√°rios respondem com telefone
- Sistema verifica duplicatas por telefone
- Telefone obrigat√≥rio, e-mail opcional

### **Question√°rio Misto (Verifica√ß√£o por E-mail):**
```json
{
  "id": "email",
  "tipo": "email",
  "campoVerificacao": true
},
{
  "id": "telefone",
  "tipo": "telefone",
  "campoVerificacao": false
}
```
- E-mail √© campo de verifica√ß√£o
- Telefone √© opcional
- Sistema usa e-mail para verifica√ß√£o

## üß™ **Testes Recomendados**

### **1. Configura√ß√£o de Campos:**
- ‚úÖ Marcar e-mail como campo de verifica√ß√£o
- ‚úÖ Marcar telefone como campo de verifica√ß√£o
- ‚úÖ Tentar marcar m√∫ltiplos campos como verifica√ß√£o
- ‚úÖ Tentar marcar campo inv√°lido como verifica√ß√£o

### **2. Valida√ß√µes:**
- ‚úÖ Criar question√°rio sem campo de verifica√ß√£o
- ‚úÖ Criar question√°rio com telefone obrigat√≥rio
- ‚úÖ Testar constraints √∫nicas no banco

### **3. Funcionamento:**
- ‚úÖ Resposta com e-mail (verifica√ß√£o por e-mail)
- ‚úÖ Resposta com telefone (verifica√ß√£o por telefone)
- ‚úÖ Resposta duplicada (deve ser detectada)
- ‚úÖ Resposta em question√°rios diferentes (deve permitir)

### **4. Interface:**
- ‚úÖ Checkbox de verifica√ß√£o funciona
- ‚úÖ Valida√ß√µes em tempo real
- ‚úÖ Feedback visual correto
- ‚úÖ Responsividade em mobile

## üö® **Considera√ß√µes Importantes**

### **Compatibilidade:**
- ‚úÖ **Question√°rios existentes** continuam funcionando
- ‚úÖ **Verifica√ß√£o por e-mail** √© o padr√£o
- ‚úÖ **Migra√ß√£o autom√°tica** para novos campos
- ‚úÖ **Campos opcionais** n√£o quebram funcionalidade

### **Performance:**
- ‚úÖ **√çndices GIN** para consultas JSONB
- ‚úÖ **Constraints √∫nicas** para integridade
- ‚úÖ **Valida√ß√µes eficientes** no banco
- ‚úÖ **Logs otimizados** para debugging

### **Seguran√ßa:**
- ‚úÖ **Valida√ß√£o de tipos** no banco
- ‚úÖ **Constraints √∫nicas** para duplicatas
- ‚úÖ **Valida√ß√£o de obrigatoriedade** autom√°tica
- ‚úÖ **Triggers** para integridade dos dados

## üéØ **Pr√≥ximos Passos**

### **Fase 1 (Atual):**
- ‚úÖ Verifica√ß√£o por e-mail ou telefone
- ‚úÖ Interface de configura√ß√£o
- ‚úÖ Valida√ß√µes autom√°ticas
- ‚úÖ Constraints √∫nicas
- ‚úÖ Logs detalhados

### **Fase 2 (Futuro):**
- üîÑ **M√∫ltiplos campos** de verifica√ß√£o
- üîÑ **Verifica√ß√£o por CNPJ** ou outros campos
- üîÑ **Regras de verifica√ß√£o** personalizadas
- üîÑ **Hist√≥rico de verifica√ß√µes** realizadas

## üö® **Troubleshooting**

### **Erro de Constraint √önica**
Se voc√™ receber o erro:
```
ERROR: 23505: could not create unique index "pessoas_telefone_questionario_id_key"
DETAIL: Key (telefone, questionario_id)=(...) is duplicated.
```

**Solu√ß√£o:**
1. Execute primeiro: `CORRECAO_DUPLICATAS_TELEFONE_SUPER_SIMPLES.sql`
2. Execute depois: `CORRECAO_COLUNA_EMAIL_NULL.sql`
3. Execute por √∫ltimo: `UPDATE_VERIFICACAO_DUPLICATAS.sql`

### **Verificar Duplicatas Manualmente**
```sql
-- Verificar duplicatas de telefone
SELECT telefone, questionario_id, COUNT(*)
FROM pessoas 
WHERE telefone IS NOT NULL 
GROUP BY telefone, questionario_id 
HAVING COUNT(*) > 1;

-- Verificar duplicatas de email
SELECT email, questionario_id, COUNT(*)
FROM pessoas 
GROUP BY email, questionario_id 
HAVING COUNT(*) > 1;
```

### **Remover Duplicatas Manualmente**
```sql
-- Remover duplicatas de telefone (mant√©m o mais recente)
DELETE FROM pessoas 
WHERE id IN (
    SELECT p1.id
    FROM pessoas p1
    INNER JOIN (
        SELECT telefone, questionario_id, MAX(created_at) as max_created_at
        FROM pessoas
        WHERE telefone IS NOT NULL
        GROUP BY telefone, questionario_id
        HAVING COUNT(*) > 1
    ) p2 ON p1.telefone = p2.telefone 
        AND p1.questionario_id = p2.questionario_id
        AND p1.created_at < p2.max_created_at
);
```

## üìû **Suporte**

Para implementar ou d√∫vidas:
1. **Execute o script de corre√ß√£o** se houver erro de constraint
2. **Execute o script principal** no Supabase
3. **Verifique se as tabelas** foram atualizadas
4. **Teste a cria√ß√£o** de question√°rios com verifica√ß√£o por telefone
5. **Teste a resposta** dos question√°rios
6. **Verifique os logs** para confirmar funcionamento
7. **Valide constraints** no banco de dados

## üéâ **Resultado Final**

Ap√≥s implementar:
- ‚úÖ **Escolha flex√≠vel** entre e-mail ou telefone
- ‚úÖ **Configura√ß√£o por question√°rio** individual
- ‚úÖ **Valida√ß√µes autom√°ticas** implementadas
- ‚úÖ **Interface intuitiva** para configura√ß√£o
- ‚úÖ **Logs detalhados** para debugging
- ‚úÖ **Constraints √∫nicas** para integridade
- ‚úÖ **Fallback autom√°tico** para e-mail
- ‚úÖ **Compatibilidade** com question√°rios existentes

## üîó **Arquivos Modificados**

- `src/components/ConfiguracaoCampos.tsx` - Checkbox de verifica√ß√£o
- `src/app/api/pessoas/upsert/route.ts` - L√≥gica de verifica√ß√£o
- `src/app/admin/(protected)/questionarios/novo/page.tsx` - Campos padr√£o
- `src/app/admin/(protected)/questionarios/[id]/campos/EditarCamposQuestionarioClient.tsx` - Edi√ß√£o
- `UPDATE_VERIFICACAO_DUPLICATAS.sql` - Script SQL principal
- `CORRECAO_DUPLICATAS_TELEFONE_SUPER_SIMPLES.sql` - Script de corre√ß√£o de duplicatas (vers√£o super-simples)
- `CORRECAO_COLUNA_EMAIL_NULL.sql` - Script para permitir email NULL
- `VERIFICACAO_DUPLICATAS_IMPLEMENTACAO.md` - Esta documenta√ß√£o

## üöÄ **Exemplo de Uso R√°pido**

### **Para verifica√ß√£o por telefone:**
1. Acesse `/admin/questionarios/novo`
2. Desmarque "üîç Campo de verifica√ß√£o" do e-mail
3. Marque "üîç Campo de verifica√ß√£o" do telefone
4. Crie o question√°rio
5. Sistema agora verifica duplicatas por telefone

### **Para verifica√ß√£o por e-mail (padr√£o):**
1. Deixe o e-mail marcado como campo de verifica√ß√£o
2. Sistema verifica duplicatas por e-mail automaticamente
3. Telefone se torna opcional
